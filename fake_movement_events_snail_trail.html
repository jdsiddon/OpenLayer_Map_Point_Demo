<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.14.2/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script src="http://openlayers.org/en/v3.14.2/build/ol.js" type="text/javascript"></script>
    <title>OpenLayers 3 example</title>
  </head>
  <body>
    <h2>Basic Map</h2>
    <div id="map" class="map"></div>

    <script type='text/javascript' src='js/EventEmitter.min.js'></script>
    <script type="text/javascript">

    var startingCoords = [49, 11];

    // Basic visible border style. Borders are red.
    var visibleBorder = new ol.style.Style({
      stroke: new ol.style.Stroke({
        width: 4,
        color: [255, 0, 0, 1]
      })
    });

    /**
     * This method converts our normal coordinates, into the projection format
     *  our map understands.
     * @function getCoords
     * @param coord, an array of coordinates [long, lat]
     * @returns coordinates in defined projection format.
     */
    function getCoords(coord) {
      return ol.proj.fromLonLat(coord, 'EPSG:3857');
    }

    // Creates an instance of View. Our maps "window".
    var view = new ol.View({
      center: getCoords([45, 1]),
      zoom: 1
    });

    // Creates our Tile layer, which handles the actual map imagery so we can see the map.
    var tileLayer = new ol.layer.Tile({
      source: new ol.source.MapQuest({layer: 'osm'})
    });

    // Creates our Point feature and assigns it a position.
    var pointFeature = new ol.Feature({
      name: 'Point',
      id: 'LocationPoint',
      geometry: new ol.geom.Point(
        getCoords(startingCoords)           // Point coords.
      )
    });

    // Sets the style of our pointFeature we defined above, without this our Point has no style, so I can't be seen.
    var pointStyle = new ol.style.Style({
      image: new ol.style.Icon({
        anchor: [0.5, 30],
        anchorXUnits: 'fraction',
        anchorYUnits: 'pixels',
        opacity: 1,
        src: 'icons/red_32.png'
      })
    });
    pointFeature.setStyle(pointStyle);        // Attaches our fancy style to our Point.

    // Create a blank "multilinestring" feature.
    // This is the feature we will add the new coordinates to as they move.
    var lineFeature = new ol.Feature({
      name: 'Path',
      geometry: new ol.geom.MultiLineString()
    });
    // Add line string to start, REQUIRED for correct init.
    lineFeature.getGeometry().appendLineString(new ol.geom.LineString(getCoords(startingCoords)));
    lineFeature.setStyle(visibleBorder);

    // Creates our Vector source (not Layer), and adds our Point feature to it. The source needs to contain
    // the features of the layer.
    var vectorSource = new ol.source.Vector({
      title: 'Our new vector!',
      features: [pointFeature, lineFeature]
    });

    // Creates our Vector layer and adds our vectorSource to it.
    var vectorLayer = new ol.layer.Vector({
      source: vectorSource
    });

    // Creates our map, adds our two layers to it, sets our view, and inserts the map into the div with id='map'.
    var map = new ol.Map({
      view: view,
      layers: [
        tileLayer,
        vectorLayer
      ],
      target: 'map'
    });

    var gpsMovement = new Array();
    gpsMovement.push(startingCoords);

    function newCoordinates(coords) {
      var newLong, newLat;
      var changeLong = Math.random();
      var changeLat = Math.random();

      if(Math.floor((Math.random() * 10) + 1) % 3 === 0) {
        changeLong *= -1;
        changeLat *= -1;
      }

      newLong = changeLong + coords[coords.length-1][0];
      newLat = changeLat + coords[coords.length-1][1];

      if(newLat < -90)
        newLat = 90;
      if(newLat > 90)
        newLat = -90;
      if(newLong < -180)
        newLong = 180;
      if(newLong > 180)
        newLong = -180;

      coords.push(getCoords([newLong, newLat])); // Push the coordinates onto our array in Web Mercator.

      console.log(coords[coords.length-1][0] + ", " + coords[coords.length-1][1]);
    }

    setInterval(function() {
      gpsDevice.getCoordinates();
    }, 2000);

    function updatePoint() {
      var iconGeom = pointFeature.getGeometry();      // Grab player icon feature.
      var pathGeom = lineFeature.getGeometry();     // Grab line segment feature.
      var pathCoords = pathGeom.getCoordinates();

      newCoordinates(gpsMovement);
      var lastMovement = pointFeature.getGeometry().getCoordinates(); // Get last coordinates.


      var segment = [
        gpsMovement[gpsMovement.length-2],                        // Last end point, current start point.
        gpsMovement[gpsMovement.length-1]                         // New end point.
      ];

      iconGeom.setCoordinates(gpsMovement[gpsMovement.length-1]);        // Update player icon coords.

      pathCoords.unshift(segment);                // Insert new segment at beginning of path array.
      pathGeom.setCoordinates(pathCoords);

      // temp = Array();
      // for(var i = 0; i < gpsMovement.length; i++) {
      //   temp.push(getCoords(gpsMovement[i]));
      // }
      // lineFeature.getGeometry().setCoordinates(temp);
      // pointFeature.getGeometry().setCoordinates(
      //   [
      //     temp
      //   ]
      // );        // Update icon coords.
      // var pathCoords = lineFeature.getGeometry().getCoordinates();
      //
      // pathCoords.unshift(gpsMovement[gpsMovement.length-1]);
    }

    function GPS() {
      this.Event = new EventEmitter();
    }

    GPS.prototype.getCoordinates = function() {
      /*
        This is where we might do a poll of our actual GPS device for its last coordinates.
      */

      // If coordinates are new emit our update event!
      this.Event.emitEvent('update');
    };

    var gpsDevice = new GPS();

    gpsDevice.Event.addListener('update', updatePoint);

    </script>
  </body>
</html>
